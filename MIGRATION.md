# データマイグレーションガイド

## sortOrderマイグレーション（2026-01-02実施済み）

### 背景
ドラッグ&ドロップ並び替え機能の追加に伴い、全ての人物データに`sortOrder`フィールドを追加する必要がありました。

### 実施内容
- **対象ユーザー**: 22名
- **更新した人物**: 55名
- **実施日**: 2026-01-02
- **ツール**: `migrate-sortorder.js` (Firebase Admin SDK使用)

### 実施結果
すべてのユーザーデータに対して、`createdAt`順で`sortOrder`を自動付与しました。

### マイグレーションスクリプトの使用方法

**⚠️ 重要**: このスクリプトは本番データベースを直接変更します。実行前に必ずバックアップを取ってください。

#### 1. サービスアカウントキーの取得
1. [Firebaseコンソール](https://console.firebase.google.com/project/biten-note-app/settings/serviceaccounts/adminsdk)にアクセス
2. 「新しい秘密鍵の生成」をクリック
3. ダウンロードしたJSONファイルをプロジェクトルートに配置

#### 2. 依存関係のインストール
```bash
npm install
```

#### 3. マイグレーション実行
```bash
npm run migrate
# または
node migrate-sortorder.js
```

#### 4. 実行後のクリーンアップ
```bash
# サービスアカウントキーを削除（セキュリティ上重要）
rm *-firebase-adminsdk-*.json
```

### 処理内容
1. 全ユーザーのデータを取得
2. 各ユーザーの`persons`コレクションを確認
3. `sortOrder`未設定の人物を抽出
4. `createdAt`順にソートして1から順番に採番
5. バッチ更新で一括保存

### 安全性
- `.gitignore`でサービスアカウントキーを除外設定済み
- 既に`sortOrder`が設定されているデータはスキップ
- バッチ更新によりFirestoreの書き込み回数を最小化

### 今後の参考
将来的にデータベーススキーマを変更する場合も、同様の方法で一括マイグレーションが可能です。
