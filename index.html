<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#667eea">
    
    <title>美点ノート</title>
    <meta name="description" content="あなたの周りの人の美点を発見・記録するアプリ">
    
    <!-- Cropper.js CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/responsive.css">
</head>
<body>
    <!-- アプリケーションコンテナ -->
    <div id="app">
        <!-- 画面がここに動的に表示されます -->
    </div>

    <!-- ローディング表示 -->
    <div id="loading" class="loading hidden">
        <div class="spinner"></div>
        <p>読み込み中...</p>
    </div>

    <!-- 写真編集モーダル -->
    <div id="photoEditModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>📷 写真を編集</h2>
                <button class="modal-close" onclick="Person.closePhotoEditor()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">写真を選択</label>
                    <input
                        type="file"
                        class="form-input"
                        id="photoEditInput"
                        accept="image/*"
                        onchange="Photo.handlePhotoSelect(event)"
                    >
                    <span class="form-hint">正方形にトリミングされます（最大150KB）</span>
                </div>

                <!-- 写真プレビュー・トリミングエリア -->
                <div id="photoPreviewArea" class="hidden">
                    <div class="form-group">
                        <label class="form-label">写真をトリミング</label>
                        <div id="cropperContainer" style="max-height: 400px;"></div>
                        <div style="margin-top: 16px; display: flex; gap: 8px;">
                            <button type="button" class="btn btn-outline" onclick="Photo.resetCropper()">
                                リセット
                            </button>
                            <button type="button" class="btn btn-primary" onclick="Photo.cropAndSave()">
                                トリミング確定
                            </button>
                        </div>
                    </div>
                </div>

                <div id="croppedPhotoPreview" class="hidden">
                    <div class="form-group">
                        <label class="form-label">トリミング済み写真</label>
                        <img id="croppedImage" style="width: 200px; height: 200px; border-radius: 12px; object-fit: cover; display: block; margin: 0 auto;">
                        <button type="button" class="btn btn-outline btn-block mt-sm" onclick="Photo.removeCroppedPhoto()">
                            写真を削除
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="Person.savePhoto()">保存</button>
                <button class="btn btn-secondary" onclick="Person.closePhotoEditor()">キャンセル</button>
            </div>
        </div>
    </div>

    <!-- Pro版モーダル -->
    <div id="proModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>✨ Pro版へのアップグレード</h2>
                <button class="modal-close" onclick="closeProModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p>無料版では最大3人まで登録できます。</p>
                <p>更に多くの人の美点を記録するには、Pro版（¥500/月）へのアップグレードが必要です。</p>
                <div class="pro-features">
                    <h3>Pro版の特典</h3>
                    <ul>
                        <li>✅ 無制限の人物登録</li>
                        <li>✅ クラウド同期機能</li>
                        <li>✅ 複数デバイス対応</li>
                        <li>✅ 高度な統計機能</li>
                    </ul>
                </div>
                <p class="coming-soon">※ Pro版は現在開発中です（Phase 3でリリース予定）</p>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeProModal()">閉じる</button>
            </div>
        </div>
    </div>

    <!-- エラーメッセージ表示用 -->
    <div id="toast" class="toast hidden"></div>

    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- Application Scripts -->
    <script src="js/config.js"></script>
    <script src="js/db.js"></script>
    <script src="js/person.js"></script>
    <script src="js/biten.js"></script>
    <script src="js/photo.js"></script>
    <script src="js/pdf.js"></script>
    <script src="js/app.js"></script>

    <!-- Global Functions -->
    <script>
        // Pro版モーダルを閉じる
        function closeProModal() {
            document.getElementById('proModal').classList.add('hidden');
        }

        // トースト通知を表示
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type}`;
            toast.classList.remove('hidden');
            
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        // ローディング表示
        function showLoading() {
            document.getElementById('loading').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loading').classList.add('hidden');
        }

        // エラーハンドリング
        window.addEventListener('error', (event) => {
            console.error('Global error:', event.error);
            showToast('エラーが発生しました', 'error');
        });

        // IndexedDB未対応ブラウザの検出
        if (!window.indexedDB) {
            alert('お使いのブラウザはこのアプリをサポートしていません。最新のChrome、Safari、Firefox、Edgeをご利用ください。');
        }
    </script>
</body>
</html>