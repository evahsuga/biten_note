<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#667eea">
    
    <title>美点ノート</title>
    <meta name="description" content="あなたの周りの人の美点を発見・記録するアプリ">
    
    <!-- Cropper.js CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/responsive.css">
</head>
<body>
    <!-- アプリケーションコンテナ -->
    <div id="app">
        <!-- 画面がここに動的に表示されます -->
    </div>

    <!-- ローディング表示 -->
    <div id="loading" class="loading hidden">
        <div class="spinner"></div>
        <p>読み込み中...</p>
    </div>

    <!-- 名前編集モーダル -->
    <div id="nameEditModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>✏️ 名前を編集</h2>
                <button class="modal-close" onclick="Person.closeNameEditor()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">名前</label>
                    <input
                        type="text"
                        class="form-input"
                        id="nameEditInput"
                        maxlength="50"
                        placeholder="名前を入力"
                        onkeypress="if(event.key === 'Enter') Person.saveName()"
                    >
                    <span class="form-hint">1〜50文字</span>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="Person.saveName()">保存</button>
                <button class="btn btn-secondary" onclick="Person.closeNameEditor()">キャンセル</button>
            </div>
        </div>
    </div>

    <!-- 関係性編集モーダル -->
    <div id="relationshipEditModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>✏️ 関係性を編集</h2>
                <button class="modal-close" onclick="Person.closeRelationshipEditor()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">関係性</label>
                    <input
                        type="text"
                        class="form-input"
                        id="relationshipEditInput"
                        maxlength="20"
                        placeholder="例: 同僚、友人、家族"
                        onkeypress="if(event.key === 'Enter') Person.saveRelationship()"
                    >
                    <span class="form-hint">1〜20文字</span>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="Person.saveRelationship()">保存</button>
                <button class="btn btn-secondary" onclick="Person.closeRelationshipEditor()">キャンセル</button>
            </div>
        </div>
    </div>

    <!-- 写真編集モーダル -->
    <div id="photoEditModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>📷 写真を編集</h2>
                <button class="modal-close" onclick="Person.closePhotoEditor()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">写真を選択</label>
                    <input
                        type="file"
                        class="form-input"
                        id="photoEditInput"
                        accept="image/*"
                        onchange="Photo.handlePhotoSelect(event)"
                    >
                    <span class="form-hint">正方形にトリミングされます（最大150KB）</span>
                </div>

                <!-- 写真プレビュー・トリミングエリア -->
                <div id="photoPreviewArea" class="hidden">
                    <div class="form-group">
                        <label class="form-label">写真をトリミング</label>
                        <div id="cropperContainer" style="max-height: 400px;"></div>
                        <div style="margin-top: 16px; display: flex; gap: 8px;">
                            <button type="button" class="btn btn-outline" onclick="Photo.resetCropper()">
                                リセット
                            </button>
                            <button type="button" class="btn btn-primary" onclick="Photo.cropAndSave()">
                                トリミング確定
                            </button>
                        </div>
                    </div>
                </div>

                <div id="croppedPhotoPreview" class="hidden">
                    <div class="form-group">
                        <label class="form-label">トリミング済み写真</label>
                        <img id="croppedImage" style="width: 200px; height: 200px; border-radius: 12px; object-fit: cover; display: block; margin: 0 auto;">
                        <button type="button" class="btn btn-outline btn-block mt-sm" onclick="Photo.removeCroppedPhoto()">
                            写真を削除
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="Person.savePhoto()">保存</button>
                <button class="btn btn-secondary" onclick="Person.closePhotoEditor()">キャンセル</button>
            </div>
        </div>
    </div>

    <!-- 美点編集モーダル -->
    <div id="bitenEditModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>✏️ 美点を編集</h2>
                <button class="modal-close" onclick="Biten.closeBitenEditor()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">美点</label>
                    <input
                        type="text"
                        class="form-input"
                        id="bitenEditInput"
                        maxlength="15"
                        placeholder="美点を入力（最大15文字）"
                    >
                    <span class="form-hint">最大15文字</span>
                </div>
            </div>
            <div class="modal-footer" style="justify-content: space-between; padding: 12px 16px;">
                <button class="btn btn-outline" onclick="Biten.deleteBitenFromModal()" style="padding: 8px 12px; font-size: 14px; min-width: auto;">🗑 削除</button>
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-secondary" onclick="Biten.closeBitenEditor()" style="padding: 8px 12px; font-size: 14px;">キャンセル</button>
                    <button class="btn btn-primary" onclick="Biten.saveBitenEdit()" style="padding: 8px 12px; font-size: 14px;">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 100個達成モーダル -->
    <div id="achievementModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>🎉 おめでとうございます！</h2>
                <button class="modal-close" onclick="closeAchievementModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="font-size: 18px; font-weight: bold; color: var(--primary); margin-bottom: 16px;">
                    100項目達成しました！
                </p>
                <p style="line-height: 1.8; margin-bottom: 16px;">
                    素晴らしいです！この人の美点を100個も発見されました。
                </p>
                <p style="line-height: 1.8; margin-bottom: 16px;">
                    これ以上の美点は記録できませんが、追加の美点発見をする際は、<strong>名前に「No.2」などとつけて新しい人物として登録</strong>することで、引き続き記録することができます。
                </p>
                <p style="line-height: 1.8; color: var(--gray-600);">
                    例: 「山田太郎」→「山田太郎 No.2」
                </p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary btn-block" onclick="closeAchievementModal()">閉じる</button>
            </div>
        </div>
    </div>

    <!-- スタンダード版モーダル -->
    <div id="proModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>✨ スタンダード版のご案内</h2>
                <button class="modal-close" onclick="closeProModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p>開発版では最大3人まで登録できます。</p>
                <p>更に多くの人の美点を記録するには、スタンダード版へのアップグレードが必要です。</p>
                <div class="pro-features">
                    <h3>スタンダード版の予定機能</h3>
                    <ul>
                        <li>✅ 無制限の人物登録</li>
                        <li>✅ クラウド同期機能</li>
                        <li>✅ 習慣、週間連続チャレンジ機能</li>
                        <li>✅ 記入美点のメールバック機能</li>
                    </ul>
                </div>
                <p class="coming-soon">※ スタンダード版は現在開発中です。</p>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeProModal()">閉じる</button>
            </div>
        </div>
    </div>

    <!-- エラーメッセージ表示用 -->
    <div id="toast" class="toast hidden"></div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>

    <!-- jsPDF とその依存ライブラリ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- jsPDF日本語フォント対応 (NotoSansJP) -->
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/polyfills.umd.js"></script>
    <script src="https://unpkg.com/jspdf@latest/dist/jspdf.umd.min.js"></script>

    <!-- Application Scripts -->
    <script src="js/config.js"></script>
    <script src="js/firebase-config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/db.js"></script>
    <script src="js/person.js"></script>
    <script src="js/biten.js"></script>
    <script src="js/photo.js"></script>
    <script src="js/pdf.js"></script>
    <script src="js/app.js"></script>

    <!-- Global Functions -->
    <script>
        // Pro版モーダルを閉じる
        function closeProModal() {
            document.getElementById('proModal').classList.add('hidden');
        }

        // 100個達成モーダルを閉じる
        function closeAchievementModal() {
            document.getElementById('achievementModal').classList.add('hidden');
        }

        // トースト通知を表示
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type}`;
            toast.classList.remove('hidden');
            
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        // ローディング表示
        function showLoading() {
            document.getElementById('loading').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loading').classList.add('hidden');
        }

        // エラーハンドリング
        window.addEventListener('error', (event) => {
            console.error('Global error:', event.error);
            showToast('エラーが発生しました', 'error');
        });
    </script>
</body>
</html>